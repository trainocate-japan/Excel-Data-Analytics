{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# A(analysis、分析)：データに基づく分析、処理\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "ここまでデータの理解を進めました。\n",
    "クロス集計や散布図を用いて可視化を行いデータの分析を行うことを探索的分析といいます。  \n",
    "本章では探索的分析ではなく、分析や検定について紹介します。\n",
    "\n",
    "## 多変量解析の基礎 - 相関と回帰分析\n",
    "多変量解析（単変量解析を含む）では、予測・要因分析が可能です。つまり、データ間にある関係性を捉えることができます。更に良い点として、分析において重要な、ある変数にある変数がどのように影響しているのかを数値的に評価することができます。つまり、うまく解析を進めると変数の因果関係を読み取ることも可能なのです。\n",
    "\n",
    "まとめると、多変量解析の手法では以下のような関係性を見つけることができます。また、数値で相対的に目的変数に対する影響度を比較することが可能です。（全ての多変量解析の手法がそうであるわけではありません。）\n",
    "\n",
    "### 相関分析\n",
    "相関分析とは文字通り、変数同士の相関を見る分析方法です。相関とは、互いに影響しあっているような状態または、関係の事を指します。\n",
    "\n",
    "例えば、アイスの販売数と気温には、気温が上がればアイスが売れるという関係がありますが、これは相関のわかりやすい一例です。\n",
    "相関分析を使用すると、関連性を相関係数という数値で定量的に評価することが可能です。つまり、相関分析とは、2 種類のデータの関係性の強さを、相関係数という数値で表す分析手法です。\n",
    "\n",
    "\n",
    "### 相関分析の実装\n",
    "\n",
    "下記について相関関係があるかどうかを調べます。\n",
    "\n",
    "- 年齢と銀行残高の相関関係\n",
    "- 売上と銀行残高の相関関係\n",
    "\n",
    "![01](img/04/01.png)\n",
    "![02](img/04/02.png)\n",
    "\n",
    "\n",
    "画像のような結果になります。銀行残高と年齢には相関関係はあまりなさそうですが、銀行残高と売上に関しては相関がありそうです。   \n",
    "**もともとの預金の多い人が定義預金講座を開講後も多くのお金を預けてくれる可能性が高い**ということがわかりました。逆に**我々の顧客は年齢によって銀行残高（貯金）に差があるということは言えない**ということもわかりました。\n",
    "\n",
    "### 相関係数をみる\n",
    "\n",
    "可視化を行うことでおおよそ 2 つの変数の間に関連性があることが分かりました。\n",
    "ですが現状は、確かにありそうであることは分かっても、「どれが最も関連性が強いですか？」という問いに回答できません。\n",
    "つまりは相対的に比較ができる定量的な指標があればよいのですが、そこで相関係数が有効に用いることができます。\n",
    "\n",
    "相関係数は、excelのデータ分析機能を使用して簡単に算出できます。　　 ここは、すべてのデータを使って確認します。（各満足度で絞ると、相関関数の計算の都合上、エラーとなってしまうためです）\n",
    "\n",
    "![04](img/04/04.png)\n",
    "\n",
    "相関の設定は下記のようにしてください。\n",
    "![05](img/04/05.png)\n",
    "\n",
    "入力範囲 : データ全体\n",
    "先頭行をラベルとして使用 : ☑\n",
    "\n",
    "結果以下のような値が算出されていれば成功です。\n",
    "![03](img/04/03.png)\n",
    "\n",
    "相関係数としても売上と銀行残高に0.656648808と算出されています。これが相関係数です。  \n",
    "一般的な指標でみるとやや相関あり、という結果です。  \n",
    "売上は成約が行われると初めて発生するものであり、成約がされてない→売上=0の行に影響されていることを考慮しましょう。  \n",
    "　　\n",
    "他の変数との組み合わせで相関係数を見ることができれば、どの変数が相関が高いのかについて答えることが可能です。\n",
    "\n",
    "### 【発展】因果関係\n",
    "\n",
    "相関分析は非常に強力な手法ですが、これにはいくつか注意点があります。相関は 2 つの変数間に因果関係があれば強く出ます。ここに注目すべき点があり、相関はお互いの影響度合いを見ている点には注意が必要です。  \n",
    "つまり上図のように、A ⇔ B の関係性を基本的に見ているので、A ⇒ B、B ⇒ A の様な関係性（因果関係）が必ず読み取れる訳ではありません。\n",
    "\n",
    "例えば、先程例に挙げた「アイスの販売数と気温」であれば、アイスの販売数 ⇒ 気温の関係でなく、気温 ⇒ アイスの販売数の関係であることが分かります。ですが、「満足度と食事の満足度」ではどうでしょうか。食事の満足度 ⇒ 満足度の関係も、満足度 ⇒ 食事の満足度の関係もどちらも成立しそうです。\n",
    "\n",
    "「宿泊したホテルの対応や内装の綺麗さなど、全体的な満足度が高かったため、食事も普段より美味しく感じた」というのも往々にして発生しそうだと想像できます。\n",
    "\n",
    "また、上記のような例を「逆の相関関係」と呼んだりします。"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 重回帰分析\n",
    "\n",
    "重回帰分析は複数の変数に対して分析を行うことが可能です。 扱う変数が複数であるため重回帰分析は多変量解析の手法です。\n",
    "\n",
    "多変量解析で行えることは大きく分けて以下の 2 つです。\n",
    "\n",
    "- 要因分析\n",
    "- 予測分析\n",
    "\n",
    "単回帰分析では、2 つの変数の関係性をモデルで表現するにとどまりますが、重回帰分析では複数の変数を扱えるようになるため、できることの幅が広がります。\n",
    "\n",
    "重回帰分析のモデル式は以下のようになります。\n",
    "\n",
    "![demo](img/04/juukaiki.png)\n",
    "\n",
    "\n",
    "- y: 目的変数（結果）\n",
    "- x: 説明変数（原因）\n",
    "- a: 偏回帰係数\n",
    "- b: 切片\n",
    "\n",
    "上式からも重回帰分析は単回帰分析の拡張版であり、 \n",
    " と \n",
    " の数が変数分だけ増えていることが分かります。また、単回帰分析の場合は、\n",
    " を回帰分析とよんでいましたが、重回帰分析では、偏回帰係数と呼びます。\n",
    "\n",
    "## 要因分析と予測分析\n",
    "先程もお伝えしましたが、重回帰分析の使用用途は要因分析と予測分析に分かれます。\n",
    "\n",
    "- 要因分析：複数ある要因（説明変数）のうち、目的変数に関連している度合いの大きいものを調べること\n",
    "- 予測分析：要因分析を元に重回帰式を求めて未来の値を予測すること\n",
    "\n",
    "単回帰分析では 1 対 1 の変数の関係を見ていたのに対し、重回帰分析では、1 対複数の変数の関係をみることになります。単回帰分析の回帰係数との違いとして、もともとのデータを上手く表現できている重回帰分析の偏回帰係数は、用いている複数の説明変数を考慮した上での目的変数に対するそれぞれの影響度合いが算出されています。\n",
    "\n",
    "### 重回帰分析の実装\n",
    "重回帰分析は変わる変数が複数になるため、単回帰分析のときのように簡単に可視化することができません。\n",
    "よってこちらの実装は分析ツールを使用して行いましょう。\n",
    "\n",
    "【分析に期待すること】\n",
    "- 売上の高い→優良顧客の発見\n",
    "- 成約はするが売上の低い顧客属性の発見\n",
    "\n",
    "\n",
    "売上予測の重回帰モデルを作成して、売上の要因→成約の要因を探す\n",
    "成約している人のみに注目し、売上に影響（成約）与える要因を探索する。\n",
    "\n",
    "\n",
    "\n",
    "データ分析 → 「回帰分析」を選択します。\n",
    "\n",
    "![06](img/04/06.png)\n",
    "　 \n",
    "「入力 Y の範囲」に売上\n",
    "「入力 X の範囲」にその他の項目（変数）を選択します。\n",
    "\n",
    "![07](img/04/07.png)\n",
    "\n",
    "\n",
    "画像のように設定ができたら OK ボタンを選択して、重回帰分析を実行しましょう。\n",
    "分析の実装が完了すると下記のように実行結果が表示されます。\n",
    "\n",
    "![08q](img/04/08-1.png)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 重回帰分析の結果の解釈\n",
    "重回帰分析の結果の解釈を行います。\n",
    "\n",
    "\n",
    "上図の注目すべき項目のみ着目して進めましょう。\n",
    "回帰分析の結果の善し悪しを評価するものに、決定係数があります。決定係数は、モデルのデータに対する当てはまりの良さ（回帰式でデータをどの程度うまく表現できているか）を表す数値で、最大が　1 となります。\n",
    "#### P 値\n",
    "Excel での回帰分析では、係数や切片に対して p 値(両側検定の結果)という値が算出されます。先程確認したように、以下の組み合わせで仮説を立てて、検定という統計処理を行った結果算出される値です。p 値については、0 に近い値を取っていればよいというふうに取られておけば構いません。 \n",
    "※ 検定については少し難解であるため、資料後半に入れています。\n",
    "\n",
    "P 値が一定の値（一般に 5）を下回れば、説明変数は目的変数に対して影響を及ぼしていると主張できるようになります。\n",
    "\n",
    "y =ax+b の場合、\n",
    "\n",
    "帰無仮説：a = 0\n",
    "\n",
    "対立仮説：a ≠ 0\n",
    "#### T 値\n",
    "先程の P 値は、説明変数が目的変数に影響しているか否かの判定には使用できますが、どの程度しているのかは判断できません。\n",
    "\n",
    "重回帰分析の場合には t 値を使用することで、複数の変数の影響度合いを考慮し、どの説明変数が結果に最も影響しているのかなどを見ることが可能です。\n",
    "t 値は偏回帰係数毎に算出されており、絶対値的に大きいほど目的変数に対する影響が大きいと判断します。また、t 値も目安の大きさがあり、t の絶対値が 2 より小さい場合は統計的にはその変数は目的変数に寄与しないと判断できます。\"**t値は個々の説明変数の有意性を判定するt検定で用いられる数値です**\n",
    "\n",
    "※ 別の方法として偏回帰係数をみて判断するという方法もあります。\n",
    "#### 係数\n",
    "係数は回帰式「Y = aX + b」のaやbの定数部分を表しています。\n",
    "今回のケースでは、導き出された係数から以下の回帰式が算出されています。\n",
    "この数値を見ることで、どの要素が目的変数に強い影響を与えているかがわかります。\n",
    "\n",
    "※ いくつかの変数の後ろの「E-○」は、Eの前の数字×0.1 の○乗を指します。今のデータにおいては、とてつもなく小さな数字になることを押さえていれば問題ありません。\n",
    "\n",
    "今回のデータはもともとの数値データが少なかったため、重回帰分析からではあまり大きな発見がありませんでした。とはいえ、売上の予測をしたり、需要予測・分析を行う際などに使用することが可能です。一つのテクニックとして抑えましょう。"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "| 項目名           | 説明                                                                                                                      | \n",
    "| ---------------- | ------------------------------------------------------------------------------------------------------------------------- | \n",
    "| 重相関R          | 相関係数のこと。                                                                                                          | \n",
    "| 標準誤差         | 得られた推定量そのもののばらつきのこと。                                                                                  | \n",
    "| 観測数           | 分析に使ったデータ数のこと。                                                                                              | \n",
    "| 回帰             | 回帰直線（式）のこと。                                                                                                    | \n",
    "| 残差             | 推定された回帰式が求めた値と、実際のデータの値の差のこと。                                                                | \n",
    "| 自由度           | 自由に決めることができる値の数のこと。現時点では、有意Fを求めるために必要な値。回帰の場合は、変数の個数を指すことが多い。 | \n",
    "| 変動             | 偏差の平方和のこと。偏差とは、データの個別の値から平均値を引いたもの。                                                    | \n",
    "| 観測された分散比 | F値のこと。有意F に使用する値。F検定に用いる。                                                                            | \n",
    "| 有意F            | すべての係数が 0 である確率のこと。0に近ければ近いほどよく、0.05未満なら統計的に「全ての係数が 0 ではない」言える。       | \n",
    "| 下限95%          | 95%の確率で係数が取りうる値の下限のこと。                                                                                 | \n",
    "| 上限95%          | 95%の確率で係数が取りうる値の上限                                                                                         | \n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Excel での機械学習分析の注意\n",
    "Excel での分析には制限があります。下記に注意してください。\n",
    "- 主な実装は重回帰分析のみ\n",
    "    成約の分析などを行う際には回帰ではなく分類の手法が好ましいです。ロジスティクス回帰や決定木はExcelではサポートされておりません。\n",
    "- 変数の制限\n",
    "    Excelでの重回帰分析では入力変数は 16 変数までときまりがあります。\n",
    "- データの数値化\n",
    "    数式にかけるため、データはすべて数値化を行う必要があります。本データは講師側ですでに数値化を行いましたが実務では数値がをする必要が発生します。\n",
    "    "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 分析結果からの考察\n",
    "まず、銀行残高・結婚状況が独身が絶対値 2 を越えているため、影響があることはあると言えそうです。 また、P 値は銀行残高とローンの有無が 0 に近い値を取っているため、関連性があると判断できます。\n",
    "\n",
    "\n",
    "\n",
    "今回の分析はすべてのデータを使用できたわけではないため、下記を参考に再度、分析結果を考えて見ましょう。画像は、コードベースで分析を行った際の影響度を可視化したものです。\n",
    "\n",
    "![09](img/04/09.png)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## まとめ\n",
    "重回帰分析の結果によって、売上に影響を与える要因として下記のようなことがわかります。  \n",
    "\n",
    "- 銀行残高・ローンの有無が売上の値と何かしらの関連がある\n",
    "- 銀行残高と結婚状況が独身の方は売上に大きな影響がある\n",
    "\n",
    "### コードでの影響度を考慮した考察を食わける\n",
    "- すでにローンを持っていたり、起業家,自営業などの職業の人が成約後、預金金額（売上の）多い傾向にあることがわかった。\n",
    "- 家政婦や無職の人は成約を行っても預金が少ない（売上が低い）ことがわかった。"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 【発展：デモ】ロジスティック回帰\n",
    "データ分析で重回帰分析と並びよく用いられる手法としてロジスティック回帰があります。\n",
    "重回帰分析は連続値を目標値として分析や予測を行う手法です。  \n",
    "つまり、今回のユースケースのような成約の有無（0or1)のようなカテゴリの分析や予測には適していません。  \n",
    "\n",
    "そういったカテゴリ→分類のユースケースにて用いられる手法がロジスティック回帰です。回帰と名前がついておりますが分類の手法です。  \n",
    "\n",
    "Excel ではこのロジスティクス回帰は搭載されておらず、サードパーティのアドインを有効化し、利用する必要があります。"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### ロジスティック回帰の実装\n",
    "#### 環境構築\n",
    "\n",
    "#### 実装\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### 結果の考察\n",
    "実装が完了すると下記のような結果のシートが出力されます。\n",
    "![lo1](img/04/logistic1.png)\n",
    "\n",
    "では結果を見てみましょう。確認をする主な指標は下記です。  \n",
    "\n",
    "- Logistic Regression Equation:計算によって割り出された数式が記載されます。\n",
    "- Logistic Regression Statistics:重回帰分析のときと同じ様は表が表示されます\n",
    "    - Coefficient:係数、数式に当てはまる重みです。\n",
    "    - z-statistic:回帰係数を標準誤差(*1)で割った値で、誤差が小さいほどこの値が大きくなります。値が大きいほど結果が信頼できる\n",
    "    - P-value:P値、0.05を下回っているかどうか(その変数が目的に対して影響しない確率が5％未満かどうか)で、その変数が目的に与える影響を判断\n",
    "    - Std.coeff:標準化した値から算出される係数\n",
    "\n",
    "続いて下記についても確認します。\n",
    "\n",
    "![lo2](img/04/logistic2.png)\n"
   ]
  }
 ],
 "metadata": {
  "language_info": {
   "name": "python"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
